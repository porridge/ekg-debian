From: Marcin Owsiany <marcin@owsiany.pl>
Subject: [PATCH] feature/alternative-build-dirs

Added support for alternative build directories.

Signed-off-by: Marcin Owsiany <marcin@owsiany.pl>

---
 Makefile.in     |   22 +++++++++++++---------
 src/Makefile.in |   18 ++++++++++++------
 2 files changed, 25 insertions(+), 15 deletions(-)

diff --git a/Makefile.in b/Makefile.in
index ad0b1d2..ae46e11 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -1,5 +1,6 @@
 # $Id$
 
+srcdir = @srcdir@
 prefix = @prefix@
 datarootdir = @datarootdir@
 datadir = @datadir@
@@ -15,7 +16,7 @@ INSTALL = @INSTALL@
 
 #
 
-all:	configure @ekg@ @make_ekgwap@
+all:	configure compat @ekg@ @make_ekgwap@
 
 ekg:	
 	cd src && $(MAKE) all
@@ -26,6 +27,9 @@ make-ekgwap:
 examples:
 	cd examples && $(MAKE) all
 
+compat:
+	mkdir -p $@
+
 #
 
 dep:
@@ -45,14 +49,14 @@ install-ekg:	install-ekg-data install-ekg-man
 
 install-ekg-data:
 	$(INSTALL) -d $(DESTDIR)$(datadir)/ekg/themes
-	$(INSTALL) -m 644 themes/*.theme $(DESTDIR)$(datadir)/ekg/themes
-	$(INSTALL) -m 644 docs/vars.txt $(DESTDIR)$(datadir)/ekg
+	$(INSTALL) -m 644 $(srcdir)/themes/*.theme $(DESTDIR)$(datadir)/ekg/themes
+	$(INSTALL) -m 644 $(srcdir)/docs/vars.txt $(DESTDIR)$(datadir)/ekg
 
 install-ekg-man:
 	$(INSTALL) -d $(DESTDIR)$(mandir)/man1
-	$(INSTALL) -m 644 docs/ekg.man.en $(DESTDIR)$(mandir)/man1/ekg.1
+	$(INSTALL) -m 644 $(srcdir)/docs/ekg.man.en $(DESTDIR)$(mandir)/man1/ekg.1
 	$(INSTALL) -d $(DESTDIR)$(mandir)/pl/man1
-	$(INSTALL) -m 644 docs/ekg.man.pl $(DESTDIR)$(mandir)/pl/man1/ekg.1
+	$(INSTALL) -m 644 $(srcdir)/docs/ekg.man.pl $(DESTDIR)$(mandir)/pl/man1/ekg.1
 
 install-ekgwap:
 	$(INSTALL) -d $(DESTDIR)$(bindir)
@@ -60,12 +64,12 @@ install-ekgwap:
 
 install-ekl2:
 	$(INSTALL) -d $(DESTDIR)$(bindir)
-	$(INSTALL) -m 755 contrib/ekl2.pl $(DESTDIR)$(bindir)
-	$(INSTALL) -m 755 contrib/ekl2.sh $(DESTDIR)$(bindir)
+	$(INSTALL) -m 755 $(srcdir)/contrib/ekl2.pl $(DESTDIR)$(bindir)
+	$(INSTALL) -m 755 $(srcdir)/contrib/ekl2.sh $(DESTDIR)$(bindir)
 	$(INSTALL) -d $(DESTDIR)$(mandir)/man1
-	$(INSTALL) -m 644 docs/ekl2.man.en $(DESTDIR)$(mandir)/man1/ekl2.1
+	$(INSTALL) -m 644 $(srcdir)/docs/ekl2.man.en $(DESTDIR)$(mandir)/man1/ekl2.1
 	$(INSTALL) -d $(DESTDIR)$(mandir)/pl/man1
-	$(INSTALL) -m 644 docs/ekl2.man.pl $(DESTDIR)$(mandir)/pl/man1/ekl2.1
+	$(INSTALL) -m 644 $(srcdir)/docs/ekl2.man.pl $(DESTDIR)$(mandir)/pl/man1/ekl2.1
 
 #
 
diff --git a/src/Makefile.in b/src/Makefile.in
index 4ea199b..5908868 100644
--- a/src/Makefile.in
+++ b/src/Makefile.in
@@ -1,5 +1,6 @@
 # $Id$
 
+srcdir= @srcdir@
 prefix = @prefix@
 datarootdir = @datarootdir@
 datadir = @datadir@
@@ -10,7 +11,7 @@ libexecdir = @libexecdir@
 sysconfdir = @sysconfdir@
 
 CC = @CC@ 
-CFLAGS = -I.. @CFLAGS@ -DDATADIR=\"${datadir}/ekg\" -DSYSCONFDIR=\"${sysconfdir}\"
+CFLAGS = -I.. -I$(srcdir) -I$(srcdir)/.. @CFLAGS@ -DDATADIR=\"${datadir}/ekg\" -DSYSCONFDIR=\"${sysconfdir}\"
 LDFLAGS = @LDFLAGS@
 LIBS = @LIBS@
 
@@ -20,18 +21,23 @@ INSTALL = @INSTALL@
 STRIP = @STRIP@
 
 OBJS = stuff.o commands.o events.o themes.o vars.o dynstuff.o userlist.o ekg.o xmalloc.o mail.o msgqueue.o emoticons.o configfile.o @OBJS@ ui-batch.o ui-none.o log.o
-SRCS = $(OBJS:.o=.c) comptime.c
+SRCS = $(patsubst %.o,$(srcdir)/%.c,$(OBJS)) $(srcdir)/comptime.c
 
+%.o: $(srcdir)/%.c
+	$(CC) $(CFLAGS) $(CPPFLAGS) $(TARGET_ARCH) -c -o $@ $<
+
+../compat/%.o: $(srcdir)/../compat/%.c
+	$(CC) $(CFLAGS) $(CPPFLAGS) $(TARGET_ARCH) -c -o $@ $<
 #
 
 all:	dep ekg @ioctld@
 
-ekg:	$(OBJS) comptime.c
-	$(CC) $(CFLAGS) -c -o comptime.o comptime.c
+ekg:	$(OBJS) $(srcdir)/comptime.c
+	$(CC) $(CFLAGS) -c -o comptime.o $(srcdir)/comptime.c
 	$(CC) $(CFLAGS) -o ekg $(OBJS) comptime.o $(LDFLAGS) $(LIBS)
 
-ioctld:	ioctld.c
-	$(CC) $(CFLAGS) ioctld.c -o ioctld $(LIBS) @IOCTLD_OBJS@
+ioctld:	$(srcdir)/ioctld.c
+	$(CC) $(CFLAGS) $< -o $@ $(LIBS) @IOCTLD_OBJS@
 
 dep:	.depend
 
-- 
tg: (5fb31dd..) feature/alternative-build-dirs (depends on: ekg-1.8rc2)
