#!/bin/sh
# $Id$

#
# jakie¶tam sta³e
#

name=ekg
version=0.9.0

#
# domy¶lne zmienne
#

cc=gcc
cflags=
prefix=/usr/local
includes=
libs=
makefile=Makefile

#
# bêdziemy testowaæ
#

tmpfile="./ekg-configure-$$-${RANDOM}"
tmpfile_c="./ekg-configure-$$-${RANDOM}.c"

#
# czy luser chce pomocy?
#

for i in "$@"; do
  if [ "$i" = "-h" -o "$i" = "-help" -o "$i" = "--help" ]; then
    cat << EOF

u¿ycie: $0 [opcje]

parametry:
	--cc		u¿yj podanego kompilatora C [${cc}]
	--prefix	u¿yj tego prefiksu do instalacji $name [${prefix}]

EOF
    exit
  fi
done

#
# sprawd¼ parametry
#

for opt do
  case "$opt" in
    --cc=*)
	cc=`echo $opt | cut -d '=' -f 2`
	;;
    --prefix=*)
	prefix=`echo $opt | cut -d '=' -f 2`
	;;
  esac
done

#
# co to za system?
#

system=`uname -s 2>&1`
echo "// ${name}-${version}"
echo "// zobaczmy, czy $system sobie poradzi..."
echo

#
# sprawd¼ czy gcc istnieje i zwraca jak±¶tam wersjê
#

echo -n "mamy kompilator? "

cc_version=`$cc -v 2>&1 | grep version`

if [ "$?" != "0" ]; then
  echo "nie dzia³a."
  exit 1
fi

if [ "$cc_version" = "" ]; then
  echo "jaki¶ dziwny."
  exit 1
fi

echo "$cc_version"

#
# zobacz, czy prosty programik da siê skompilowaæ
#

echo -n "zobaczmy, czy potrafi kompilowaæ... "

cat > $tmpfile_c << EOF
int main() {
	return 5;
}
EOF

if ! $cc $tmpfile_c -o $tmpfile > /dev/null 2>&1; then
  rm -f $tmpfile $tmpfile_c
  echo "nie."
  exit 1
fi

$tmpfile

if [ "$?" != "5" ]; then
  rm -f $tmpfile $tmpfile_c
  echo "nie najlepiej."
  exit 1
fi

rm -f $tmpfile $tmpfile_c

echo "mhm."

#
# mozemy uzyc -pipe?
#

echo -n "sprawdzimy, czy kompilator obsluguje opcje -pipe... "
cat > $tmpfile_c << EOF
int main() {
	return 7;
}
EOF

if ! $cc $tmpfile_c -pipe -o $tmpfile > /dev/null 2>&1; then
  rm -f $tmpfile $tmpfile_c
  echo "nie."
else 
 $tmpfile >/dev/null 2>&1
 if [ "$?" != "7" ]; then
   rm -f $tmpfile $tmpfile_c
   echo "jakos dziwnie??"
 else 
   rm -f $tmpfile $tmpfile_c
   cflags="$cflags -pipe"
   echo "taaak."
 fi 
fi

#
# endiany.
#

echo -n "teraz endianowo¶æ... "

cat > $tmpfile_c << EOF

#include <stdio.h>
int main()
{
	int i = 0;

	((char *)(&i))[0] = 1;
	printf("/* plik generowany przez skrypt configure */\n");
	printf("#define __LITTLE_ENDIAN 1234\n");
	printf("#define __BIG_ENDIAN    4321\n");
	printf("#define __BYTE_ORDER __%s_ENDIAN\n",
		(i == 1) ? "LITTLE" : "BIG");
	return (i == 1);
}
EOF

if ! $cc $tmpfile_c -o $tmpfile > /dev/null 2>&1; then
  rm -f $tmpfile $tmpfile_c
  echo "kompilator siê popsu³."
  exit
fi

$tmpfile > endian.h

if [ "$?" = "1" ]; then
  echo "little endian."
else
  echo "big endian."
fi

rm -f $tmpfile $tmpfile_c

#
# termcap potrzebny do readline
#

echo -n "poszukajmy termcap... "

cat > $tmpfile_c << EOF
//#include <termcap.h>
int main() {
	char *a, *b;
	tgetent(a, b);
	return 0;
}
EOF

if $cc $tmpfile_c -o $tmpfile -ltermcap > /dev/null 2>&1; then
  rm -f $tmpfile $tmpfile_c
  echo "jest."
  libs="$libs -ltermcap"
else
  echo "nie ma."
  echo -n "to mo¿e ncurses... "
  if $cc $tmpfile_c -o $tmpfile -lncurses -I/usr/include/ncurses > /dev/null 2>&1; then
    rm -f $tmpfile $tmpfile_c
    echo "tak!"
    libs="$libs -lncurses"
    includes="$includes -I/usr/include/ncurses"
  else
    echo "nie."
    echo -n "a chocia¿ samo curses... "
    if $cc $tmpfile_c -o $tmpfile -lcurses > /dev/null 2>&1; then
      rm -f $tmpfile $tmpfile_c
      echo "uff, jest."
      libs="$libs -lcurses"
    else
      rm -f $tmpfile $tmpfile_c
      echo "te¿ nie ma."
      exit 1
    fi
  fi
fi

#
# readline
#

echo -n "jeszcze tylko readline... "

cat > $tmpfile_c << EOF
#include <stdio.h>
#include <stdlib.h>
#include <readline/readline.h>
int main() {
	printf("wersja %s\n", rl_library_version);
}
EOF

if ! $cc $tmpfile_c -o $tmpfile -lreadline $includes $libs > /dev/null 2>&1; then
  if ! $cc $tmpfile_c -o $tmpfile -I/usr/freeware/include -L/usr/freeware/lib32 -lreadline $includes $libs > /dev/null 2>&1; then
    if ! $cc $tmpfile_c -o $tmpfile -I/usr/pkg/include -L/usr/pkg/lib -lreadline $libs $includes > /dev/null 2>&1; then
      echo "nie ma."
      rm -f $tmpfile $tmpfile_c
      exit 1
    else
      libs="$libs -L/usr/pkg/lib -lreadline"
      includes="$includes -I/usr/pkg/include"
    fi
  else
    libs="$libs -L/usr/freeware/lib32 -lreadline"
    includes="$includes -I/usr/freeware/include"
  fi
else
  libs="$libs -lreadline"
fi

$tmpfile 2>&1
rm -f $tmpfile $tmpfile_c

#
# Makefile.in -> Makefile
#

echo -n "generujê Makefile... "

rm -f $makefile
echo "# plik wygenerowany automatyczny przez skrypt ,,configure''. nie zmieniaæ." > $makefile
if ! sed -e "s|@includes@|${includes}|" -e "s|@libs@|${libs}|" -e "s|@prefix@|${prefix}|" -e "s|@name@|${name}|" -e "s|@version@|${version}|" -e "s|@cc@|${cc}|" -e "s|@cflags@|${cflags}|" < ${makefile}.in | grep -v '# \$\I\d' >> $makefile; then
  echo "b³±d sed'a."
  rm -f $makefile
  exit 1
fi
echo "gotowe."
echo
echo "wpisz ,,make'' by rozpocz±æ kompilacjê. potem mo¿esz u¿yæ polecenia"
echo ",,make install'' by zainstalowaæ program w odpowiednim miejscu."
echo

